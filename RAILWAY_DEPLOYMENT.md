# Deploy no Railway

## Configura√ß√£o de Vari√°veis de Ambiente

Para o backend funcionar corretamente no Railway, as seguintes vari√°veis de ambiente devem ser configuradas:

### Op√ß√£o 1: Usando DATABASE_URL (recomendado)
Se voc√™ tiver um servi√ßo MySQL hospedado externamente ou no Railway:

```
DATABASE_URL=mysql://username:password@host:port/database_name
```

### Op√ß√£o 2: Usando vari√°veis separadas
Se voc√™ estiver usando o servi√ßo MySQL do Railway:

```
DB_HOST=mysql.railway.internal
DB_USER=root
DB_PASSWORD=hKqzfPhyDJLAJujRUPjZebecKknlbMVN
DB_NAME=railway
PORT=2540
NODE_ENV=production
CORS_ORIGIN=https://cursotecnicoinfobva-frontend-production.up.railway.app
TRUST_PROXY=true
```

## Script de Inicializa√ß√£o

Certifique-se de que o Railway esteja usando o script correto para iniciar o servidor:

**Comando de inicializa√ß√£o:** `npm start`

Ou se preferir o script de produ√ß√£o:

**Comando de inicializa√ß√£o:** `npm run production`

**Importante:** O Railway n√£o deve usar `npm run dev` em produ√ß√£o, pois isso pode causar problemas de desempenho e seguran√ßa.

## Configura√ß√µes Adicionais

### CORS
As origens permitidas j√° est√£o configuradas para funcionar com dom√≠nios do Railway:

```
https://*.railway.app
https://*.up.railway.app
```

## Troubleshooting

### Banco de dados mockado sendo usado
Se o log mostrar "Usando banco de dados mockado", verifique:

1. **Vari√°veis de ambiente**: Confirme que `DATABASE_URL` ou as vari√°veis `DB_*` est√£o configuradas corretamente
2. **Conex√£o com MySQL**: Verifique se o servi√ßo MySQL est√° ativo no Railway
3. **Script de inicializa√ß√£o**: Confirme que est√° usando `npm start` e n√£o `npm run dev`

### URLs com barras duplicadas
Se o frontend mostrar erros como `//api/auth/me` (com duas barras), isso foi resolvido com as seguintes corre√ß√µes:

1. **Frontend**: Atualizado `api.ts` para garantir que n√£o haja barra final no `baseURL`
2. **Backend**: Configurado para servir rotas tanto com quanto sem prefixo `/api` para manter compatibilidade

### Rotas 404 no m√≥dulo estudante
Se as rotas `/subjects` e `/activities/student` retornarem 404 apenas no m√≥dulo estudante no Railway, isso foi resolvido com:

1. **Padroniza√ß√£o de rotas**: Agora todas as rotas principais est√£o dispon√≠veis tanto com quanto sem prefixo `/api` no backend
2. **Corre√ß√£o no frontend**: Garantido que n√£o haja conflito de URLs com dupla barra
3. **Configura√ß√£o do frontend**: Usar `VITE_API_URL=https://cursotecnicoinfobva-backend-production.up.railway.app/api` no ambiente de produ√ß√£o

### Host bloqueado no frontend (Vite)
Se aparecer "Blocked request. This host is not allowed", verifique o `vite.config.ts`:
- Adicione os dom√≠nios do Railway em `server.allowedHosts`
- Dom√≠nios comuns: `.railway.app`, `.up.railway.app`

### Logs √∫teis
O middleware de banco de dados mostra logs detalhados como:
- `üîç Debug - Vari√°veis de ambiente do banco de dados`
- `üì° Configura√ß√£o de conex√£o final`
- `üîå Tentando conectar ao MySQL`

## Estrutura do Banco de Dados

O sistema espera as seguintes tabelas no banco de dados:
- `users`
- `profiles`
- `user_roles`
- `subjects`
- `teacher_subjects`
- `enrollments`
- `activities`
- `activity_grades`
- `grades`
- `attendances`
- `subject_content`
- `subject_resources`

## Scripts Dispon√≠veis

- `npm start` - Inicia o servidor em modo de produ√ß√£o
- `npm run production` - Inicia com NODE_ENV=production explicitamente
- `npm run dev` - Modo de desenvolvimento com hot reload (n√£o recomendado para produ√ß√£o)

## Health Check

O servidor responde em `/api` com uma mensagem de status para verifica√ß√£o de sa√∫de da aplica√ß√£o.

## Deploy Checklist

Antes de fazer o deploy:

- [ ] Vari√°veis de ambiente configuradas corretamente
- [ ] Script de inicializa√ß√£o definido como `npm start`
- [ ] Banco de dados MySQL ativo e configurado
- [ ] Frontend configurado com URL do backend com prefixo `/api`
- [ ] Verificar logs ap√≥s deploy para confirmar conex√£o com banco de dados

## Problemas Comuns e Solu√ß√µes

### Erro "jsxDEV is not a function" no frontend
Se o frontend mostrar este erro, pode ser necess√°rio instalar o plugin `@vitejs/plugin-react` e atualizar o `vite.config.ts` para us√°-lo em vez de `@vitejs/plugin-react-swc`.

**Solu√ß√£o:**
1. Instale o plugin: `npm install @vitejs/plugin-react --save-dev`
2. Atualize o `vite.config.ts` para importar e usar `@vitejs/plugin-react` em vez de `@vitejs/plugin-react-swc`
3. Rebuild o projeto para produ√ß√£o

### Rotas retornando 404 no Railway - Problema Resolvido
O problema de rotas como `/subjects` e `/activities/student` retornando 404 apenas no m√≥dulo estudante no Railway foi resolvido com:

1. **Compatibilidade total no backend**: Agora todas as rotas principais est√£o dispon√≠veis tanto com quanto sem prefixo `/api` para garantir funcionamento em ambos ambientes
2. **Corre√ß√£o de dupla barra no frontend**: Atualizado o servi√ßo de API para evitar URLs com `//`
3. **Configura√ß√£o**: O frontend deve usar `VITE_API_URL` com o sufixo `/api` para ambiente de produ√ß√£o, mas as rotas funcionam em ambos formatos
4. **Manuten√ß√£o de compatibilidade**: Tanto `/api/subjects` quanto `/subjects` funcionam para manter ambos ambientes operacionais
